<!--
  Muen system policy for a NetHSM firmware updater system.
-->
<system>
  <config>
    <boolean name="xhcidbg_enabled" value="false"/>
    <boolean name="dbgserver_serial_enabled" value="false"/>
    <boolean name="dbgserver_sink_pcspkr" value="false"/>
    <boolean name="dbgserver_sink_shmem" value="false"/>
    <boolean name="pciconf_emulation_enabled" value="false"/>
    <string name="logchannel_size" value="16#0002_0000#"/>
  </config>
  <include href="common_expressions.xml"/>
  <memory>
    <include href="updater_memory.xml"/>
  </memory>
  <deviceDomains>
    <include href="updater_device_domains.xml"/>
  </deviceDomains>
  <events>
    <event name="resume_linux_2" mode="switch"/>
    <event name="trap_to_sm_2" mode="switch"/>
    <event name="reset_linux_2" mode="switch"/>
    <event name="timer_linux_2" mode="self"/>
    <event name="system_reboot" mode="kernel"/>
    <event name="system_poweroff" mode="kernel"/>
    <event name="system_panic" mode="kernel"/>
  </events>
  <channels>
    <channel name="time_info" size="16#1000#"/>

    <channel name="debuglog_platform" size="$logchannel_size"/>
    <channel name="debuglog_time" size="$logchannel_size"/>
  </channels>
  <subjects>
    <include href="subject_platform_updater_sm.xml"/>
    <include href="subject_time.xml"/>
    <subject name="dbgserver">
      <events>
        <source>
          <group name="vmx_exit">
            <default physical="system_panic">
              <system_panic/>
            </default>
          </group>
        </source>
      </events>
      <component ref="dbgserver">
        <map logical="log_channel1" physical="debuglog_platform"/>
        <map logical="log_channel3" physical="debuglog_time"/>
        <include href="subject_dbgserver_common.xml"/>
      </component>
    </subject>
    <subject name="platform">
      <vcpu> <!-- <vcpu> must come first -->
        <vmx>
          <controls>
            <proc>
              <!-- Enable access to full-precision RDTSC -->
              <RDTSCExiting>0</RDTSCExiting>
            </proc>
          </controls>
        </vmx>
      </vcpu>
      <bootparams>console=ttyS0,115200 pci=noearly iomem=relaxed uroot.uinitargs=platform_updater</bootparams>
      <memory>
        <memory logical="initramfs" physical="initramfs" virtualAddress="16#9000_0000#" writable="false" executable="false"/>
      </memory>
      <devices>
        <device logical="storage_controller" physical="storage_controller">
          <pci bus="16#00#" device="16#17#" function="0"/>
        </device>
        <device logical="serial_device_1" physical="serial_device_1">
        </device>
        <device logical="lpc_controller" physical="lpc_controller">
          <pci bus="16#00#" device="16#1f#" function="0"/>
        </device>
        <device logical="spi_controller" physical="spi_controller">
          <pci bus="16#00#" device="16#1f#" function="5"/>
        </device>
        <device logical="pci_legacy" physical="pci_legacy">
        </device>
        <!-- XXX: This is defined by the hardare policy, but we need it for port 0cf9 -->
        <device logical="system_board" physical="system_board">
        </device>
      </devices>
      <events>
        <source>
          <group name="vmx_exit">
            <default physical="trap_to_sm_2"/>
          </group>
          <group name="vmcall">
            <event id="31" logical="timer" physical="timer_linux_2"/>
            <event id="30" logical="poweroff" physical="system_poweroff">
              <system_poweroff/>
            </event>
            <event id="29" logical="reboot" physical="system_reboot">
              <system_reboot/>
            </event>
          </group>
        </source>
        <target>
          <event logical="resume_after_trap" physical="resume_linux_2"/>
          <event logical="reset" physical="reset_linux_2">
            <reset/>
          </event>
          <event logical="timer" physical="timer_linux_2">
            <inject_interrupt vector="236"/>
          </event>
        </target>
      </events>
      <component ref="linux">
        <map logical="lowmem" physical="platform|lowmem"/>
        <map logical="ram" physical="platform|ram"/>
      </component>
    </subject>
  </subjects>
  <!--
    Static scheduling plan is included here directly, no dependency on
    upstream's policy/scheduling/...
  -->
  <scheduling tickRate="10000">
    <majorFrame>
      <cpu id="0">
        <minorFrame subject="tau0" ticks="5"/>
        <minorFrame subject="dbgserver" ticks="15"/>
      </cpu>
      <cpu id="1">
        <minorFrame subject="time" ticks="5"/>
        <minorFrame subject="platform" ticks="15"/>
      </cpu>
    </majorFrame>
    <majorFrame>
      <cpu id="0">
         <minorFrame subject="tau0" ticks="5"/>
         <minorFrame subject="dbgserver" ticks="15"/>
      </cpu>
      <cpu id="1">
         <minorFrame subject="platform" ticks="20"/>
      </cpu>
    </majorFrame>
  </scheduling>
</system>
