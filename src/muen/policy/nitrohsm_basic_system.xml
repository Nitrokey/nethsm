<!--
  Muen system policy for a basic NitroHSM, i.e. one with nic_linux serving as
  S-Net-External, and storage_linux serving as S-Kitchen-Sink.

  TODO: Consider dropping dependency on or using a copy of upstream's
  mirageos/cspec_src.xml, in order to be 100% self-contained?
-->
<system>
  <config>
    <boolean name="xhcidbg_enabled" value="false"/>
    <boolean name="dbgserver_serial_enabled" value="true"/>
    <boolean name="dbgserver_sink_pcspkr" value="false"/>
    <boolean name="dbgserver_sink_shmem" value="false"/>
    <boolean name="pciconf_emulation_enabled" value="false"/>
    <string name="logchannel_size" value="16#0002_0000#"/>
  </config>
  <include href="common_expressions.xml"/>
  <memory>
    <memory name="initramfs" size="16#0100_0000#" caching="WB" type="subject_initrd">
      <file filename="initramfs.cpio.gz" offset="none"/>
    </memory>
    <memory name="nic_linux|ram" size="16#1000_0000#" caching="WB"/>
    <memory name="nic_linux|lowmem" size="16#0008_0000#" caching="WB"/>
    <memory name="storage_linux|ram" size="16#1000_0000#" caching="WB"/>
    <memory name="storage_linux|lowmem" size="16#0008_0000#" caching="WB"/>
    <memory name="crash_audit" physicalAddress="16#0001_0000_0000#" size="16#1000#" caching="UC" type="subject_crash_audit"/>
  </memory>
  <deviceDomains>
    <include href="common_device_domains.xml"/>
  </deviceDomains>
  <events>
    <event name="resume_linux_1" mode="switch"/>
    <event name="resume_linux_2" mode="switch"/>
    <event name="trap_to_sm_1" mode="switch"/>
    <event name="trap_to_sm_2" mode="switch"/>
    <event name="trap_to_sl_1" mode="switch"/>
    <event name="start_linux_1" mode="switch"/>
    <event name="reset_linux_1" mode="switch"/>
    <event name="reset_linux_2" mode="switch"/>
    <event name="reset_sm_1" mode="switch"/>
    <event name="serial_irq4_linux_1" mode="async"/>
    <event name="serial_irq4_linux_2" mode="async"/>
    <event name="timer_linux_1" mode="self"/>
    <event name="timer_linux_2" mode="self"/>
    <event name="reboot_linux_1" mode="self"/>
    <event name="resume_unikernel_1" mode="switch"/>
    <event name="trap_to_sm_3" mode="switch"/>
    <event name="system_reboot" mode="kernel"/>
    <event name="system_poweroff" mode="kernel"/>
    <event name="system_panic" mode="kernel"/>
  </events>
  <channels>
    <channel name="time_info" size="16#1000#"/>

    <channel name="debuglog_subject2" size="$logchannel_size"/>
    <channel name="debuglog_subject3" size="$logchannel_size"/>
    <channel name="debuglog_subject4" size="$logchannel_size"/>
    <channel name="debuglog_subject5" size="$logchannel_size"/>
    <channel name="debuglog_subject7" size="$logchannel_size"/>
    <channel name="debuglog_subject8" size="$logchannel_size"/>

    <if variable="dbgserver_sink_shmem" value="true">
      <channel name="debug_shm_sink_memory" size="16#0002_0000#"/>
    </if>
    <channel name="unikernel_external_in" size="16#0010_0000#"/>
    <channel name="unikernel_external_out" size="16#0010_0000#"/>
    <channel name="unikernel_internal_in" size="16#0010_0000#"/>
    <channel name="unikernel_internal_out" size="16#0010_0000#"/>
  </channels>
  <components>
    <!--
      Generated by solo5-muen-gencspec.py from
      <upstream policy dir>/mirageos/cspec_src.xml.
    -->
    <include href="component_unikernel.xml"/>
  </components>
  <subjects>
    <include href="subject_nic_sm.xml"/>
    <include href="subject_storage_sm.xml"/>
    <include href="subject_time.xml"/>
    <include href="subject_nic_sl.xml"/>
    <subject name="dbgserver">
      <events>
        <source>
          <group name="vmx_exit">
            <default physical="system_panic">
              <system_panic/>
            </default>
          </group>
        </source>
      </events>
      <component ref="dbgserver">
        <map logical="log_channel2" physical="debuglog_subject2"/>
        <map logical="log_channel3" physical="debuglog_subject3"/>
        <map logical="log_channel4" physical="debuglog_subject4"/>
        <map logical="log_channel5" physical="debuglog_subject5"/>
        <map logical="log_channel7" physical="debuglog_subject7"/>
        <map logical="log_channel8" physical="debuglog_subject8"/>
        <include href="subject_dbgserver_common.xml"/>
      </component>
    </subject>
    <subject name="nic_linux">
      <bootparams>console=ttyS0 pci=noearly uroot.uinitargs=nic_linux</bootparams>
      <memory>
        <memory logical="initramfs" physical="initramfs" virtualAddress="16#9000_0000#" writable="false" executable="false"/>
      </memory>
      <devices>
        <device logical="eth0" physical="ethernet_controller_1"/>
      </devices>
      <events>
        <source>
          <group name="vmx_exit">
            <default physical="trap_to_sm_1"/>
            <event id="33" logical="reset" physical="reset_sm_1"/>
          </group>
          <group name="vmcall">
            <event id="30" logical="reboot" physical="reboot_linux_1"/>
            <event id="31" logical="timer" physical="timer_linux_1"/>
          </group>
        </source>
        <target>
          <event logical="resume_after_trap" physical="resume_linux_1"/>
          <event logical="resume_after_reset" physical="start_linux_1"/>
          <event logical="reset" physical="reset_linux_1">
            <reset/>
          </event>
          <event logical="reboot" physical="reboot_linux_1">
            <reset/>
          </event>
          <event logical="serial_irq4" physical="serial_irq4_linux_1">
            <inject_interrupt vector="52"/>
          </event>
          <event logical="timer" physical="timer_linux_1">
            <inject_interrupt vector="236"/>
          </event>
        </target>
      </events>
      <channels>
        <writer logical="external|in" physical="unikernel_external_in" virtualAddress="16#000e_0300_0000#"/>
        <reader logical="external|out" physical="unikernel_external_out" virtualAddress="16#000e_0310_0000#"/>
      </channels>
      <component ref="linux">
        <map logical="lowmem" physical="nic_linux|lowmem"/>
        <map logical="ram" physical="nic_linux|ram"/>
      </component>
    </subject>
    <subject name="storage_linux">
      <bootparams>console=ttyS0 pci=noearly uroot.uinitargs=storage_linux</bootparams>
      <memory>
        <memory logical="initramfs" physical="initramfs" virtualAddress="16#9000_0000#" writable="false" executable="false"/>
      </memory>
      <devices>
        <device logical="xhci" physical="usb_controller_1"/>
        <device logical="storage_controller" physical="storage_controller">
          <pci bus="16#00#" device="16#1f#" function="0"/>
        </device>
      </devices>
      <events>
        <source>
          <group name="vmx_exit">
            <default physical="trap_to_sm_2"/>
          </group>
          <group name="vmcall">
            <event id="31" logical="timer" physical="timer_linux_2"/>
          </group>
        </source>
        <target>
          <event logical="resume_after_trap" physical="resume_linux_2"/>
          <event logical="reset" physical="reset_linux_2">
            <reset/>
          </event>
          <event logical="serial_irq4" physical="serial_irq4_linux_2">
            <inject_interrupt vector="52"/>
          </event>
          <event logical="timer" physical="timer_linux_2">
            <inject_interrupt vector="236"/>
          </event>
        </target>
      </events>
      <channels>
        <writer logical="internal|in" physical="unikernel_internal_in" virtualAddress="16#000e_0320_0000#"/>
        <reader logical="internal|out" physical="unikernel_internal_out" virtualAddress="16#000e_0330_0000#"/>
      </channels>
      <component ref="linux">
        <map logical="lowmem" physical="storage_linux|lowmem"/>
        <map logical="ram" physical="storage_linux|ram"/>
      </component>
    </subject>
    <subject name="unikernel_sm">
      <events>
        <source>
          <group name="vmx_exit">
            <default physical="system_panic">
              <system_panic/>
            </default>
          </group>
        </source>
      </events>
      <monitor>
        <state subject="unikernel" logical="monitor_state" virtualAddress="16#001e_0000#" writable="true"/>
      </monitor>
      <component ref="sm">
        <map logical="time_info" physical="time_info"/>
        <map logical="debuglog" physical="debuglog_subject7"/>
	<map logical="resume_subject" physical="resume_unikernel_1"/>
	<map logical="handle_subject_trap" physical="trap_to_sm_3"/>
      </component>
    </subject>
    <subject name="unikernel">
      <bootparams></bootparams>
      <events>
        <source>
          <group name="vmx_exit">
            <default physical="trap_to_sm_3"/>
          </group>
        </source>
        <target>
          <event logical="resume_after_trap" physical="resume_unikernel_1"/>
        </target>
      </events>
      <component ref="unikernel">
        <map logical="time_info" physical="time_info"/>
        <map logical="debuglog" physical="debuglog_subject8"/>
        <map logical="external|in" physical="unikernel_external_in"/>
        <map logical="external|out" physical="unikernel_external_out"/>
        <map logical="internal|in" physical="unikernel_internal_in"/>
        <map logical="internal|out" physical="unikernel_internal_out"/>
      </component>
    </subject>
  </subjects>
  <!--
    Static scheduling plan is included here directly, no dependency on
    upstream's policy/scheduling/...
  -->
  <scheduling tickRate="1000">
    <majorFrame>
      <cpu id="0">
        <minorFrame subject="tau0" ticks="20"/>
        <minorFrame subject="nic_linux" ticks="80"/>
        <minorFrame subject="unikernel" ticks="20"/>
        <minorFrame subject="nic_linux" ticks="20"/>
      </cpu>
      <cpu id="1">
        <minorFrame subject="time" ticks="20"/>
        <minorFrame subject="dbgserver" ticks="30"/>
        <minorFrame subject="storage_linux" ticks="90"/>
      </cpu>
    </majorFrame>
    <majorFrame>
      <cpu id="0">
         <minorFrame subject="tau0" ticks="5"/>
         <minorFrame subject="nic_linux" ticks="80"/>
         <minorFrame subject="unikernel" ticks="40"/>
         <minorFrame subject="nic_linux" ticks="20"/>
      </cpu>
      <cpu id="1">
         <minorFrame subject="storage_linux" ticks="115"/>
         <minorFrame subject="dbgserver" ticks="30"/>
      </cpu>
    </majorFrame>
  </scheduling>
</system>
